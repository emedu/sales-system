# 03_技術手冊

## 1. 系統架構說明
本系統採用 **Next.js Full Stack** 架構：
- **Frontend**: React Server Components (RSC) + Client Components (互動表單)。
- **Backend**: Next.js App Router API Routes。
- **Database**: Google Sheets (雲端試算表作為資料庫)。

### 資料來源
- **學生資料**: 從 Google Sheets「總表」工作表讀取
- **課程資料**: 靜態列表 (美容丙級、美容乙級、紋繡全科、美甲全科、美睫全科)
- **成交記錄**: 寫入 Google Sheets「成交回報_DB」工作表
- **銷售漏斗追蹤**: Google Sheets「流程追蹤」工作表 (20 欄位,追蹤 4 階段轉換)

### 目錄結構
- `src/app`: 頁面路由
  - `sales/`: 成交回報頁面
  - `dashboard/`: 報表頁面
  - `api/`: 後端接口
- `src/components`: UI 元件 (Shadcn/UI)
- `prisma`: 資料庫定義與種子資料

## 2. 安裝與啟動指南 (Installation & Setup)
### 前置需求
- Node.js LTS (v18+)
- Git
- Google Service Account 憑證 (google-key.json)

### 首次安裝
```bash
# 1. 進入專案目錄
cd sales-system

# 2. 安裝依賴
npm install

# 3. 設定 Google Sheets API 憑證
# 將 google-key.json 放置於專案根目錄
# 或設定環境變數 GOOGLE_CREDENTIALS_JSON
```

### Google Sheets API 設定
1. **取得 Service Account 憑證**：
   - 前往 [Google Cloud Console](https://console.cloud.google.com/)
   - 建立新專案或選擇現有專案
   - 啟用 Google Sheets API
   - 建立 Service Account 並下載 JSON 憑證
   - 將憑證檔案命名為 `google-key.json` 並放置於專案根目錄

2. **授權 Service Account 存取試算表**：
   - 開啟目標 Google Sheets
   - 點擊「共用」按鈕
   - 將 Service Account 的 email 加入為編輯者

3. **環境變數設定** (Vercel 部署時使用)：
   ```bash
   GOOGLE_CREDENTIALS_JSON={完整的 JSON 憑證內容}
   ```

### 啟動開發伺服器
```bash
npm run dev
```

## 3. API 說明

### 3.1 基礎 API
| 方法 | 路徑 | 描述 | 資料來源 |
| --- | --- | --- | --- |
| GET | `/api/students` | 取得所有學生資料 | Google Sheets「總表」 |
| GET | `/api/products` | 取得所有課程資料 | 靜態列表 |
| POST | `/api/sales` | 新增成交紀錄 | 寫入 Google Sheets「成交回報_DB」 |
| GET | `/api/dashboard` | 取得戰情分析所需之聚合數據 | 聚合 Google Sheets 資料 |

### 3.2 銷售漏斗追蹤 API
| 方法 | 路徑 | 描述 | 資料來源 |
| --- | --- | --- | --- |
| GET | `/api/funnel` | 取得漏斗分析數據 (各階段人數與轉換率) | Google Sheets「流程追蹤」 |
| GET | `/api/student/[id]/stage` | 取得特定學生的漏斗追蹤狀態 | Google Sheets「流程追蹤」 |
| POST | `/api/student/[id]/stage` | 更新學生的當前階段與相關資料 | 寫入 Google Sheets「流程追蹤」 |
| GET | `/api/analytics/consultant` | 取得諮詢師績效分析 | 聚合「流程追蹤」資料 |

#### 3.2.1 更新學生階段範例
```bash
# 更新到 Stage 2.1 (聯繫成功)
POST /api/student/A001/stage
Content-Type: application/json

{
  "stage": "2.1 聯繫成功",
  "consultant": "王小明",
  "contactMethod": "電話",
  "contactNotes": "已聯繫,學生有興趣"
}
```

#### 3.2.2 漏斗分析回應範例
```json
{
  "totalStudents": 1142,
  "stages": [
    {
      "stage": "1. 首次洽詢",
      "count": 1142,
      "percentage": 100
    },
    {
      "stage": "2.1 聯繫成功",
      "count": 856,
      "percentage": 75
    },
    {
      "stage": "3.1 邀約成功",
      "count": 514,
      "percentage": 45
    }
    // ... 其他階段
  ]
}
```

## 4. 部署說明
### Vercel 部署
1. 推送程式碼到 GitHub
2. 在 Vercel Dashboard 設定環境變數：
   - `GOOGLE_CREDENTIALS_JSON`: 完整的 Service Account JSON 憑證
3. 部署完成後，系統會自動連接 Google Sheets
